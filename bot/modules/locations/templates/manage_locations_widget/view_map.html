<!-- Leaflet CSS -->
<link rel="stylesheet" href="/static/leaflet.css"/>

<style>
    #map {
        height: 600px;
        width: 100%;
        background: #1a1a1a;
        border: 2px solid var(--lcars-hopbush);
        border-radius: 8px;
    }
    .leaflet-container {
        background: #1a1a1a;
    }
    .location-marker {
        background-color: var(--lcars-golden-tanoi);
        border: 2px solid var(--lcars-tanoi);
        border-radius: 50%;
        width: 12px;
        height: 12px;
    }
    .player-marker {
        background-color: var(--lcars-anakiwa);
        border: 2px solid var(--lcars-mariner);
        border-radius: 50%;
        width: 10px;
        height: 10px;
    }
    .map-controls {
        margin-bottom: 10px;
        padding: 10px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 4px;
    }
</style>

{{ control_switch_view }}

<div id="map"></div>

<!-- Leaflet JS -->
<script src="/static/leaflet.js"></script>

<script>
// Wait for Leaflet to load
(function initMap() {
    if (typeof L === 'undefined') {
        console.log('Waiting for Leaflet to load...');
        setTimeout(initMap, 100);
        return;
    }

    console.log('[MAP] Initializing 7D2D map...');

    // Check if map container exists
    const mapContainer = document.getElementById('map');
    if (!mapContainer) {
        console.error('[MAP] Map container #map not found!');
        return;
    }
    console.log('[MAP] Map container found:', mapContainer);

    // 7 Days to Die uses a simple coordinate system (not lat/lon)
    // We need to transform game coordinates to pixel coordinates
    const MAP_BOUNDS = [[-4096, -4096], [4096, 4096]]; // Typical 7D2D map size
    const TILE_SERVER = 'http://95.216.65.202:26902/map/{z}/{x}/{y}.png';

    // Create custom CRS for 7D2D coordinates
    const crs = L.extend({}, L.CRS.Simple, {
        transformation: new L.Transformation(1/32, 128, -1/32, 128)
    });

    // Initialize map
    console.log('[MAP] Creating Leaflet map instance...');
    const map = L.map('map', {
        crs: crs,
        minZoom: -5,
        maxZoom: 4,
        zoom: 0,
        center: [0, 0],
        attributionControl: false
    });
    console.log('[MAP] Map instance created');

    // Add tile layer
    L.tileLayer(TILE_SERVER, {
        tileSize: 256,
        noWrap: true,
        bounds: MAP_BOUNDS
    }).addTo(map);

    // Storage for markers
    const locationMarkers = {};
    const playerMarkers = {};

    // Add location markers
    const locations = {{ locations_json|safe }};
    console.log('[MAP] Locations data:', locations);
    console.log('[MAP] Number of locations:', Object.keys(locations).length);

    Object.keys(locations).forEach(function(locationId) {
        const loc = locations[locationId];
        const coords = [loc.pos_z, loc.pos_x]; // Leaflet uses [y, x] format

        const marker = L.circleMarker(coords, {
            radius: 6,
            fillColor: '#ff9900',
            color: '#ffcc00',
            weight: 2,
            opacity: 1,
            fillOpacity: 0.8,
            className: 'location-marker'
        }).addTo(map);

        marker.bindPopup('<b>' + loc.name + '</b><br>Type: ' + (loc.type || []).join(', '));
        locationMarkers[locationId] = marker;
    });

    // Add player markers
    const players = {{ players_json|safe }};
    console.log('[MAP] Players data:', players);
    console.log('[MAP] Number of players:', Object.keys(players).length);

    Object.keys(players).forEach(function(steamid) {
        const player = players[steamid];
        if (player.pos) {
            const coords = [player.pos.z, player.pos.x];

            const marker = L.circleMarker(coords, {
                radius: 5,
                fillColor: '#66ccff',
                color: '#0099ff',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.9,
                className: 'player-marker'
            }).addTo(map);

            marker.bindPopup('<b>' + player.name + '</b><br>Level: ' + player.level);
            playerMarkers[steamid] = marker;
        }
    });

    // Listen for real-time player position updates
    window.socket.on('data', function(data) {
        if (data.data_type === 'player_position_update') {
            const steamid = data.steamid;
            const pos = data.position;

            if (playerMarkers[steamid]) {
                // Update existing marker
                playerMarkers[steamid].setLatLng([pos.z, pos.x]);
            } else if (pos) {
                // Create new marker
                const marker = L.circleMarker([pos.z, pos.x], {
                    radius: 5,
                    fillColor: '#66ccff',
                    color: '#0099ff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.9,
                    className: 'player-marker'
                }).addTo(map);

                marker.bindPopup('<b>' + (data.name || 'Player') + '</b>');
                playerMarkers[steamid] = marker;
            }
        }
    });

    // Fit map to show all markers on load
    const allMarkers = Object.values(locationMarkers).concat(Object.values(playerMarkers));
    console.log('[MAP] Total markers:', allMarkers.length);

    if (allMarkers.length > 0) {
        const group = L.featureGroup(allMarkers);
        map.fitBounds(group.getBounds().pad(0.1));
        console.log('[MAP] Map fitted to bounds');
    } else {
        console.log('[MAP] No markers to display, using default center');
    }

    console.log('[MAP] Map initialization complete!');

    // Fix map size after a short delay (in case container was hidden initially)
    setTimeout(function() {
        map.invalidateSize();
        console.log('[MAP] Map size invalidated/refreshed');
    }, 250);
})();
</script>
