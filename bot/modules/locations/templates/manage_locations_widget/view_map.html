<!-- Leaflet CSS -->
<link rel="stylesheet" href="/static/leaflet.css"/>

<style>
    /* Reset main to work with existing layout */
    main {
        display: flex;
        flex-direction: column;
        flex: 1;
        min-height: 0;
        padding: 0;
    }

    /* LCARS Grid Layout Container */
    .map-grid-container {
        display: grid;
        grid-template-columns: 1fr 320px;
        grid-template-rows: 50px 1fr 120px;
        grid-template-areas:
            "topbar topbar"
            "map sidebar"
            "bottombar bottombar";
        gap: 8px;
        height: 100%;
        min-height: 0;
        padding: 8px;
        box-sizing: border-box;
    }

    /* Top Bar */
    .lcars-topbar {
        grid-area: topbar;
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: rgba(26, 26, 26, 0.95);
        border: 2px solid var(--lcars-hopbush);
        border-radius: 25px;
        padding: 0 20px;
        gap: 20px;
    }

    .lcars-topbar-left {
        display: flex;
        gap: 12px;
        align-items: center;
    }

    .zoom-controls {
        display: flex;
        gap: 4px;
    }

    .zoom-btn {
        background: var(--lcars-anakiwa);
        border: 2px solid var(--lcars-anakiwa);
        color: #000;
        padding: 6px 12px;
        border-radius: 15px;
        cursor: pointer;
        font-weight: bold;
        font-size: 16px;
        transition: all 0.2s ease;
        min-width: 36px;
        text-align: center;
    }

    .zoom-btn:hover {
        background: var(--lcars-golden-tanoi);
        border-color: var(--lcars-golden-tanoi);
        transform: scale(1.05);
    }

    .zoom-btn:active {
        transform: scale(0.95);
    }

    .lcars-topbar-right {
        display: flex;
        gap: 12px;
        align-items: center;
        font-family: monospace;
        font-size: 14px;
        color: var(--lcars-anakiwa);
    }

    .coord-label {
        font-weight: bold;
        color: var(--lcars-hopbush);
    }

    /* Map Container */
    .lcars-map-container {
        grid-area: map;
        background: #1a1a1a;
        border: 2px solid var(--lcars-hopbush);
        border-radius: 8px;
        overflow: hidden;
        position: relative;
    }

    #map {
        width: 100%;
        height: 100%;
        background: #1a1a1a;
    }

    .leaflet-container {
        background: #1a1a1a;
    }

    /* Disable default Leaflet popups */
    .leaflet-popup {
        display: none !important;
    }

    /* Right Sidebar */
    .lcars-sidebar {
        grid-area: sidebar;
        background: rgba(26, 26, 26, 0.95);
        border: 2px solid var(--lcars-anakiwa);
        border-radius: 8px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        gap: 8px;
        padding: 0;
    }

    /* Player List Section (top of sidebar) */
    .lcars-player-list {
        flex: 0 0 240px;
        border-bottom: 2px solid var(--lcars-anakiwa);
        overflow-y: auto;
        overflow-x: hidden;
        padding: 12px;
        font-family: monospace;
        font-size: 12px;
    }

    .lcars-player-list h3 {
        margin: 0 0 12px 0;
        color: var(--lcars-anakiwa);
        font-size: 14px;
        border-bottom: 2px solid var(--lcars-anakiwa);
        padding-bottom: 6px;
        position: sticky;
        top: 0;
        background: rgba(26, 26, 26, 0.95);
        z-index: 10;
    }

    .player-list-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 6px 8px;
        margin-bottom: 4px;
        background: rgba(0, 0, 0, 0.3);
        border-left: 3px solid var(--lcars-anakiwa);
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .player-list-item:hover {
        background: rgba(102, 204, 255, 0.2);
        border-left-color: var(--lcars-golden-tanoi);
        transform: translateX(2px);
    }

    .player-list-item.offline {
        opacity: 0.5;
        border-left-color: #666;
    }

    .player-list-item.offline:hover {
        opacity: 0.7;
    }

    .player-status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        flex-shrink: 0;
    }

    .player-status-dot.online {
        background: #66ff66;
        box-shadow: 0 0 4px #66ff66;
    }

    .player-status-dot.offline {
        background: #666;
    }

    .player-list-name {
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: var(--lcars-anakiwa);
        font-weight: bold;
    }

    .player-list-level {
        color: var(--lcars-golden-tanoi);
        font-size: 11px;
    }

    /* Details Section (bottom of sidebar) */
    .lcars-details {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        padding: 12px;
        font-family: monospace;
        font-size: 12px;
    }

    .lcars-details h3 {
        margin: 0 0 12px 0;
        color: var(--lcars-anakiwa);
        font-size: 16px;
        border-bottom: 2px solid var(--lcars-anakiwa);
        padding-bottom: 6px;
    }

    .lcars-sidebar-empty {
        color: #666;
        text-align: center;
        padding: 40px 20px;
        font-size: 13px;
    }

    /* Bottom Bar */
    .lcars-bottombar {
        grid-area: bottombar;
        display: flex;
        gap: 8px;
    }

    .lcars-legend {
        flex: 0 0 300px;
        background: rgba(26, 26, 26, 0.95);
        border: 2px solid var(--lcars-hopbush);
        border-radius: 8px;
        padding: 12px;
        font-family: monospace;
        font-size: 12px;
        line-height: 1.6;
        color: var(--lcars-golden-tanoi);
    }

    .lcars-legend h4 {
        margin: 0 0 8px 0;
        color: var(--lcars-hopbush);
        font-size: 14px;
        font-weight: bold;
        border-bottom: 1px solid var(--lcars-hopbush);
        padding-bottom: 4px;
    }

    .legend-item {
        margin: 2px 0;
        display: flex;
        justify-content: space-between;
        gap: 10px;
        font-size: 11px;
    }

    .legend-label {
        color: var(--lcars-anakiwa);
        font-weight: bold;
    }

    .legend-value {
        color: var(--lcars-golden-tanoi);
        text-align: right;
    }

    .lcars-other {
        flex: 1;
        background: rgba(26, 26, 26, 0.95);
        border: 2px solid var(--lcars-golden-tanoi);
        border-radius: 8px;
        padding: 12px;
        color: var(--lcars-golden-tanoi);
        font-family: monospace;
        font-size: 11px;
    }

    /* Create Location Button */
    .create-location-btn {
        background: var(--lcars-hopbush);
        border: 2px solid var(--lcars-hopbush);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        cursor: pointer;
        font-weight: bold;
        font-size: 13px;
        transition: all 0.3s ease;
        white-space: nowrap;
    }
    .create-location-btn:hover {
        background: var(--lcars-golden-tanoi);
        border-color: var(--lcars-golden-tanoi);
        color: #000;
    }
    .create-location-btn.active {
        background: var(--lcars-tanoi);
        border-color: var(--lcars-tanoi);
        animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }

    /* Marker styles */
    .location-marker {
        background-color: var(--lcars-golden-tanoi);
        border: 2px solid var(--lcars-tanoi);
        border-radius: 50%;
        width: 12px;
        height: 12px;
    }
    .player-marker {
        background-color: var(--lcars-anakiwa);
        border: 2px solid var(--lcars-mariner);
        border-radius: 50%;
        width: 10px;
        height: 10px;
    }
</style>

<header>
    <div>
        <span>Locations Map</span>
    </div>
</header>
<aside>
{{ control_switch_view }}
</aside>
<main>
    <div class="map-grid-container">
        <!-- Top Bar: Controls & Coordinates -->
        <div class="lcars-topbar">
            <div class="lcars-topbar-left">
                <button class="create-location-btn" id="create-location-btn">üìç Create Location</button>
                <div class="zoom-controls">
                    <button class="zoom-btn" id="zoom-in" title="Zoom In">+</button>
                    <button class="zoom-btn" id="zoom-out" title="Zoom Out">‚àí</button>
                </div>
            </div>
            <div class="lcars-topbar-right">
                <span class="coord-label">X:</span> <span id="coord-x">0</span>
                <span style="margin: 0 4px;">|</span>
                <span class="coord-label">Z:</span> <span id="coord-z">0</span>
            </div>
        </div>

        <!-- Map Container -->
        <div class="lcars-map-container">
            <div id="map"></div>
        </div>

        <!-- Right Sidebar: Player List + Details -->
        <div class="lcars-sidebar">
            <!-- Player List (top) -->
            <div class="lcars-player-list" id="player-list">
                <h3>üë• Players (<span id="player-count">0</span>)</h3>
                <div id="player-list-items">
                    <div class="lcars-sidebar-empty" style="padding: 20px 10px;">
                        No players online
                    </div>
                </div>
            </div>

            <!-- Details Panel (bottom) -->
            <div class="lcars-details" id="details-panel">
                <div class="lcars-sidebar-empty">
                    Click on a player or location<br>to view details
                </div>
            </div>
        </div>

        <!-- Bottom Bar: Legend & Other -->
        <div class="lcars-bottombar">
            <div class="lcars-legend" id="map-legend">
                <h4>üó∫Ô∏è Map Info</h4>
                <div class="legend-item">
                    <span class="legend-label">Loading...</span>
                </div>
            </div>
            <div class="lcars-other">
                <b>System Status:</b> Active<br>
                <b>Socket.IO:</b> Connected<br>
                <b>Updates:</b> Real-time
            </div>
        </div>
    </div>

<!-- Leaflet JS -->
<script src="/static/leaflet.js"></script>

<script>
// Wait for Leaflet to load
(function initMap() {
    if (typeof L === 'undefined') {
        setTimeout(initMap, 100);
        return;
    }

    // Check if map container exists
    const mapContainer = document.getElementById('map');
    if (!mapContainer) {
        console.error('[MAP] Map container #map not found!');
        return;
    }

    // 7D2D Projection (from Alloc's mod)
    const SDTD_Projection = {
        project: function (latlng) {
            return new L.Point(
                (latlng.lat) / Math.pow(2, 4),
                (latlng.lng) / Math.pow(2, 4)
            );
        },
        unproject: function (point) {
            return new L.LatLng(
                point.x * Math.pow(2, 4),
                point.y * Math.pow(2, 4)
            );
        }
    };

    // 7D2D CRS (from Alloc's mod)
    const SDTD_CRS = L.extend({}, L.CRS.Simple, {
        projection: SDTD_Projection,
        transformation: new L.Transformation(1, 0, -1, 0),
        scale: function (zoom) {
            return Math.pow(2, zoom);
        }
    });

    // Initialize map with 7D2D CRS
    const map = L.map('map', {
        crs: SDTD_CRS,
        center: [0, 0],
        zoom: 3,
        minZoom: -1,
        maxZoom: 7,
        attributionControl: false,
        zoomControl: false  // Disable default zoom controls
    });

    // Create custom panes for proper layering
    // Locations should be below players so players are always clickable
    map.createPane('locationPane');
    map.getPane('locationPane').style.zIndex = 400; // Below default markerPane (600)

    map.createPane('playerPane');
    map.getPane('playerPane').style.zIndex = 650; // Above locationPane, below popups (700)

    // Create tile layer (Y-axis flipping handled by backend)
    const tileLayer = L.tileLayer('/map_tiles/{z}/{x}/{y}.png', {
        tileSize: 128,
        minNativeZoom: 0,
        minZoom: -1,
        maxNativeZoom: 4,
        maxZoom: 7
    }).addTo(map);

    // Storage for markers and shapes
    const locationShapes = {};
    const playerMarkers = {};

    // Data variables for locations and players (initially empty, loaded via socket.io)
    const locations = {};
    const players = {};

    // ========================================
    // Location Shape Creation Function
    // ========================================
    {{ webmap_templates.location_shapes|safe }}

    // ========================================
    // Location Sidebar Display
    // ========================================
    {{ webmap_templates.location_sidebar|safe }}

    // ========================================
    // Player Popup Creation (for legacy compatibility)
    // ========================================
    {{ webmap_templates.player_popup|safe }}

    // ========================================
    // Player Sidebar Display
    // ========================================
    {{ webmap_templates.player_sidebar|safe }}

    // ========================================
    // Real-time Update Handlers
    // ========================================

    // Remove old map handler if it exists from previous view load
    if (window.mapDataHandler) {
        window.socket.off('data', window.mapDataHandler);
    }

    // Create NEW handler function that captures current local scope
    // This must be recreated each time to access current locationShapes/playerMarkers
    window.mapDataHandler = function(data) {
        const handlerStart = performance.now();

        // Log incoming player updates
        if (data.data_type === 'player_position_update') {
            console.log(`[WEBSOCKET] player_position_update received at ${handlerStart.toFixed(2)}ms`);
        }

        // Map metadata (gameprefs, dataset info)
        if (data.data_type === 'map_metadata' && data.payload) {
            gameprefs = data.payload.gameprefs || {};
            activeDataset = data.payload.active_dataset || 'Unknown';
            updateLegend();

        }

        // Player position updates
        {{ webmap_templates.player_update_handler|safe }}

        // Location updates and removals
        {{ webmap_templates.location_update_handler|safe }}

        // Update legend counts and player list after any changes
        if (data.data_type === 'player_position_update' || data.data_type === 'location_update' || data.data_type === 'location_remove') {
            updateLegend();
        }

        // Update player list after player updates
        if (data.data_type === 'player_position_update') {
            updatePlayerList();
        }

        // Log total handler time for player updates
        if (data.data_type === 'player_position_update') {
            const handlerEnd = performance.now();
            console.log(`[WEBSOCKET] Total handler time: ${(handlerEnd - handlerStart).toFixed(2)}ms`);
        }
    };

    // Register the new handler
    window.socket.on('data', window.mapDataHandler);

    // Fit map to show all markers and shapes on load
    const allMapObjects = Object.values(locationShapes).concat(Object.values(playerMarkers));

    if (allMapObjects.length > 0) {
        const group = L.featureGroup(allMapObjects);
        map.fitBounds(group.getBounds().pad(0.1));
    }

    // Fix map size after a short delay (in case container was hidden initially)
    setTimeout(function() {
        map.invalidateSize();
    }, 250);

    // ========================================
    // Map Legend in Bottom Bar (LCARS Fixed Position)
    // ========================================

    // Map metadata variables (loaded via socket.io)
    let gameprefs = {};
    let activeDataset = 'Loading...';

    // Function to update legend content in bottom bar
    function updateLegend() {
        const start = performance.now();
        const legendDiv = document.getElementById('map-legend');
        if (!legendDiv) return;

        const gameName = gameprefs['GameName'] || activeDataset;
        const gameWorld = gameprefs['GameWorld'] || 'N/A';
        const worldGenSeed = gameprefs['WorldGenSeed'] || 'N/A';
        const worldGenSize = gameprefs['WorldGenSize'] || 'N/A';
        const locationCount = Object.keys(locations).length;
        const playerCount = Object.keys(players).length;

        legendDiv.innerHTML = `
            <h4>üó∫Ô∏è Map Info</h4>
            <div class="legend-item">
                <span class="legend-label">World:</span>
                <span class="legend-value">${gameName}</span>
            </div>
            <div class="legend-item">
                <span class="legend-label">Type:</span>
                <span class="legend-value">${gameWorld}</span>
            </div>
            <div class="legend-item">
                <span class="legend-label">Size:</span>
                <span class="legend-value">${worldGenSize}</span>
            </div>
            <div class="legend-item">
                <span class="legend-label">Seed:</span>
                <span class="legend-value">${worldGenSeed}</span>
            </div>
            <div class="legend-item">
                <span class="legend-label">Locations:</span>
                <span class="legend-value">${locationCount}</span>
            </div>
            <div class="legend-item">
                <span class="legend-label">Players:</span>
                <span class="legend-value">${playerCount}</span>
            </div>
        `;
        const end = performance.now();
        console.log(`[LEGEND] updateLegend took ${(end - start).toFixed(2)}ms`);
    }

    // Initial legend update
    updateLegend();

    // ========================================
    // Player List in Sidebar (LCARS Fixed Position)
    // ========================================

    // Function to update player list in sidebar
    function updatePlayerList() {
        const start = performance.now();
        const playerListItems = document.getElementById('player-list-items');
        const playerCountSpan = document.getElementById('player-count');
        if (!playerListItems || !playerCountSpan) return;

        const playerArray = Object.entries(players).map(([steamid, player]) => ({
            steamid,
            ...player
        }));

        // Sort: online first, then by name
        playerArray.sort((a, b) => {
            const aOnline = a.pos && !a.in_limbo;
            const bOnline = b.pos && !b.in_limbo;
            if (aOnline !== bOnline) return bOnline ? 1 : -1;
            return (a.name || '').localeCompare(b.name || '');
        });

        playerCountSpan.textContent = playerArray.length;

        if (playerArray.length === 0) {
            playerListItems.innerHTML = `
                <div class="lcars-sidebar-empty" style="padding: 20px 10px;">
                    No players online
                </div>
            `;
            return;
        }

        playerListItems.innerHTML = playerArray.map(player => {
            const isOnline = player.pos && !player.in_limbo;
            const statusClass = isOnline ? 'online' : 'offline';
            const itemClass = isOnline ? '' : ' offline';
            return `
                <div class="player-list-item${itemClass}" onclick="selectPlayer('${player.steamid}')">
                    <div class="player-status-dot ${statusClass}"></div>
                    <div class="player-list-name">${player.name || 'Unknown'}</div>
                    <div class="player-list-level">Lv ${player.level || 0}</div>
                </div>
            `;
        }).join('');
        const end = performance.now();
        console.log(`[PLAYERLIST] updatePlayerList took ${(end - start).toFixed(2)}ms`);
    }

    // Function to select a player from the list (zoom to position and show details)
    window.selectPlayer = function(steamid) {
        const player = players[steamid];
        if (!player) return;

        // Show player details in sidebar
        showPlayerInSidebar(steamid, player);

        // If player has a position, zoom to it
        if (player.pos && playerMarkers[steamid]) {
            map.setView([player.pos.x, player.pos.z], 5, {
                animate: true,
                duration: 0.5
            });

            // Optional: Highlight the marker briefly
            const marker = playerMarkers[steamid];
            const originalRadius = marker.options.radius;
            marker.setRadius(originalRadius * 2);
            setTimeout(() => {
                marker.setRadius(originalRadius);
            }, 500);
        }
    };

    // Initial player list update
    updatePlayerList();

    // ========================================
    // Zoom Controls in Top Bar (LCARS Fixed Position)
    // ========================================

    // Hook up zoom buttons
    document.getElementById('zoom-in').onclick = function() {
        map.zoomIn();
    };

    document.getElementById('zoom-out').onclick = function() {
        map.zoomOut();
    };

    // ========================================
    // Coordinates in Top Bar (LCARS Fixed Position)
    // ========================================

    // Update coordinates on mouse move
    map.on('mousemove', function(e) {
        const coords = e.latlng;
        // In 7D2D, lat corresponds to X and lng to Z
        document.getElementById('coord-x').textContent = Math.round(coords.lat);
        document.getElementById('coord-z').textContent = Math.round(coords.lng);
    });

    // ========================================
    // Create Location Button in Top Bar (LCARS Fixed Position)
    // ========================================

    // Store tempMarker globally so it can be accessed by confirm/cancel functions
    let tempMarker = null;

    // Hook up the create location button
    const createBtn = document.getElementById('create-location-btn');
    let creationMode = false;

    createBtn.onclick = function() {
        creationMode = !creationMode;

        if (creationMode) {
            createBtn.classList.add('active');
            createBtn.innerHTML = '‚úñÔ∏è Cancel';
            map.getContainer().style.cursor = 'crosshair';

            // Add click handler for location creation
            map.once('click', function(e) {
                const coords = e.latlng;
                const x = Math.round(coords.lat);
                const z = Math.round(coords.lng);

                // Show in sidebar
                showNewLocationConfirmation(x, z, coords);

                // Reset button state
                createBtn.classList.remove('active');
                createBtn.innerHTML = 'üìç Create Location';
                map.getContainer().style.cursor = '';
                creationMode = false;
            });
        } else {
            createBtn.classList.remove('active');
            createBtn.innerHTML = 'üìç Create Location';
            map.getContainer().style.cursor = '';

            // Remove temp marker if exists
            if (tempMarker) {
                map.removeLayer(tempMarker);
                tempMarker = null;
            }
        }
    };

    // Function to show new location confirmation in sidebar
    function showNewLocationConfirmation(x, z, coords) {
        // Create temporary marker
        tempMarker = L.circleMarker([coords.lat, coords.lng], {
            radius: 8,
            fillColor: '#ff00ff',
            color: '#ff00ff',
            weight: 3,
            opacity: 1,
            fillOpacity: 0.6
        }).addTo(map);

        const sidebar = document.getElementById('details-panel');
        sidebar.innerHTML = `
            <h3>üìç New Location</h3>
            <div style="padding: 12px 0;">
                <b style="color: var(--lcars-hopbush);">Position:</b><br>
                X: ${x}, Z: ${z}
                <br><br>
                <button onclick="confirmLocation(${x}, ${z})"
                    style="width: 100%; padding: 10px; margin-bottom: 8px; background: var(--lcars-hopbush); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                    ‚úÖ Create Here</button>
                <button onclick="cancelLocation()"
                    style="width: 100%; padding: 10px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                    ‚ùå Cancel</button>
            </div>
        `;
    }

    // Global functions for location creation confirmation
    window.confirmLocation = function(x, z) {
        // Navigate to create_new view with pre-filled coordinates using WebSocket
        // This follows the exact same pattern as all other action calls in the system
        window.socket.emit(
            'widget_event',                    // Socket event name
            ['locations',                      // Module identifier
             ['toggle_locations_widget_view',  // Action identifier
              {                                // Action parameters
                  'action': 'show_create_new',
                  'prefill_x': x,
                  'prefill_z': z,
                  'prefill_y': 0              // Default Y coordinate
              }]]
        );



        // Remove temp marker
        if (tempMarker) {
            map.removeLayer(tempMarker);
            tempMarker = null;
        }
    };

    window.cancelLocation = function() {
        // Remove temp marker
        if (tempMarker) {
            map.removeLayer(tempMarker);
            tempMarker = null;
        }

        // Reset sidebar to empty state
        const sidebar = document.getElementById('details-panel');
        sidebar.innerHTML = `
            <div class="lcars-sidebar-empty">
                Click on a player or location<br>to view details
            </div>
        `;
    };

    // ========================================
    // Location Actions (Edit, Enable, Move, Set Teleport)
    // ========================================
    {{ webmap_templates.location_actions|safe }}

    // ========================================
    // Player Actions (Kick, Message, Mute, Auth, Teleport)
    // ========================================
    {{ webmap_templates.player_actions|safe }}

})();
</script>
</main>
