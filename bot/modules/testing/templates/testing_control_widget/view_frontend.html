<header>
    <div>
        <span>Testing</span>
    </div>
</header>
<aside>
{{ options_toggle }}
</aside>
<main>
    <table class="form_table">
        <caption>
            <span>Injections: {{ injection_count }}</span>
            <span>Scenarios: {{ scenarios_loaded|length }}</span>
        </caption>
        <thead>
            <tr>
                <th>Test Data Injection</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>
                    <!-- Raw Telnet Line Injection -->
                    <table class="box_input">
                        <thead>
                            <tr>
                                <th colspan="2">Inject Raw Telnet Line</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="2">
                                    <div>
                                        <textarea id="raw_telnet_line" rows="2" placeholder="2025-11-19T18:00:00 1000.000 INF ..."></textarea>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="2">
                                    <div>
                                        <a href="#" onclick="inject_raw_telnet_line(); return false;">inject line</a>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="2">
                                    <div>
                                        {% if last_injected_line and last_injected_line != 'None' %}
                                        Last: {{ last_injected_line }}
                                        {% else %}
                                        Injects a raw telnet line to trigger normal processing
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                        </tfoot>
                    </table>

                    <!-- Player Join -->
                    <table class="box_input">
                        <thead>
                            <tr>
                                <th colspan="4">Simulate Player Join</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="4">
                                    <div>
                                        <label>Name: <input size="20" name="player_join_name" type="text" value="TestPlayer_001" /></label>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="4">
                                    <div>
                                        <label>SteamID (optional): <input size="20" name="player_join_steamid" type="text" placeholder="76561198999000001" /></label>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div>
                                        <label>x: <input size="6" name="player_join_x" type="text" value="100" /></label>
                                    </div>
                                </td>
                                <td>
                                    <div>
                                        <label>y: <input size="6" name="player_join_y" type="text" value="50" /></label>
                                    </div>
                                </td>
                                <td>
                                    <div>
                                        <label>z: <input size="6" name="player_join_z" type="text" value="200" /></label>
                                    </div>
                                </td>
                                <td>
                                    <div>
                                        <a href="#" onclick="join_player(); return false;">join player</a>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="4">
                                    <div>Generates EnterMultiplayer and JoinMultiplayer events</div>
                                </td>
                            </tr>
                        </tfoot>
                    </table>

                    <!-- Player Teleport -->
                    <table class="box_input">
                        <thead>
                            <tr>
                                <th colspan="4">Simulate Player Teleport</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="4">
                                    <div>
                                        <label>SteamID: <input size="20" name="player_teleport_steamid" type="text" placeholder="76561198999000001" /></label>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div>
                                        <label>x: <input size="6" name="player_teleport_x" type="text" value="500" /></label>
                                    </div>
                                </td>
                                <td>
                                    <div>
                                        <label>y: <input size="6" name="player_teleport_y" type="text" value="50" /></label>
                                    </div>
                                </td>
                                <td>
                                    <div>
                                        <label>z: <input size="6" name="player_teleport_z" type="text" value="500" /></label>
                                    </div>
                                </td>
                                <td>
                                    <div>
                                        <a href="#" onclick="teleport_player(); return false;">teleport player</a>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="4">
                                    <div>Updates player position via Teleport event</div>
                                </td>
                            </tr>
                        </tfoot>
                    </table>

                    <!-- Load Scenario -->
                    <table class="box_input">
                        <thead>
                            <tr>
                                <th colspan="2">Load Test Scenario</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    <div>
                                        <select name="scenario_select">
                                            <option value="">-- Choose a scenario --</option>
                                            {% for scenario in available_scenarios %}
                                            <option value="{{ scenario }}">{{ scenario }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </td>
                                <td>
                                    <div>
                                        <a href="#" onclick="load_scenario(); return false;">load scenario</a>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="2">
                                    <div>Loads pre-defined test scenarios (basic, stress, permissions)</div>
                                </td>
                            </tr>
                        </tfoot>
                    </table>

                    <!-- Cleanup -->
                    <table class="box_input">
                        <thead>
                            <tr>
                                <th>Cleanup Test Data</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    <div>
                                        <a href="#" onclick="cleanup_test_data(); return false;">cleanup all test data</a>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td>
                                    <div>
                                        Removes: Players (76561198999*), Locations (test_*), Datasets (TestWorld_*)
                                    </div>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </td>
            </tr>
        </tbody>
    </table>
</main>

<script>
    function inject_raw_telnet_line() {
        let line = document.getElementById('raw_telnet_line').value;
        if (!line) {
            alert('Please enter a telnet line');
            return;
        }
        window.socket.emit('widget_event', ['testing', ['inject_telnet_line', {
            'line': line
        }]]);
        document.getElementById('raw_telnet_line').value = '';
    }

    function join_player() {
        let name = $("input[name='player_join_name']").val();
        let steamid = $("input[name='player_join_steamid']").val();
        let x = parseInt($("input[name='player_join_x']").val());
        let y = parseInt($("input[name='player_join_y']").val());
        let z = parseInt($("input[name='player_join_z']").val());

        let data = {name: name, pos: {x: x, y: y, z: z}};
        if (steamid) data.steamid = steamid;

        window.socket.emit('widget_event', ['testing', ['inject_player_join', data]]);
    }

    function teleport_player() {
        let steamid = $("input[name='player_teleport_steamid']").val();
        if (!steamid) {
            alert('Please enter a SteamID');
            return;
        }
        let x = parseInt($("input[name='player_teleport_x']").val());
        let y = parseInt($("input[name='player_teleport_y']").val());
        let z = parseInt($("input[name='player_teleport_z']").val());

        window.socket.emit('widget_event', ['testing', ['inject_player_teleport', {
            steamid: steamid,
            pos: {x: x, y: y, z: z}
        }]]);
    }

    function load_scenario() {
        let scenario = $("select[name='scenario_select']").val();
        if (!scenario) {
            alert('Please select a scenario');
            return;
        }
        window.socket.emit('widget_event', ['testing', ['load_test_scenario', {
            scenario: scenario
        }]]);
    }

    function cleanup_test_data() {
        if (!confirm('Remove ALL test data? (Players: 76561198999*, Locations: test_*, Datasets: TestWorld_*)')) {
            return;
        }
        window.socket.emit('widget_event', ['testing', ['cleanup_test_data', {
            confirm: true
        }]]);
    }
</script>
